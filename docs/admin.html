<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>GraffityReport-Admin</title>

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:opsz@14..32&display=swap" rel="stylesheet">

        <!-- Leaflet CSS для карты -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

        <link rel="stylesheet" href="admin.css">
    </head>
    <body>
        <div class="login-overlay">
            <div class="card-password">
                <form id="admin-login" class="form-password">
                    <input type="password" id="admin_pw" class="password-input" placeholder="Введите пароль" required>
                    <button type="submit" class="button-enter">Вход</button>
                </form>
            </div>
        </div>

        <!-- Переключатель вида -->
        <div class="view-switcher" style="display: none;">
            <button class="view-btn active" onclick="switchView('list')">Список</button>
            <button class="view-btn" onclick="switchView('map')">Карта</button>
        </div>

        <!-- Список заявок -->
        <div id="applications-list" class="applications-view active">
            <ul id="app-list"></ul>
        </div>

        <!-- Карта заявок -->
        <div id="applications-map" class="applications-view">
            <div id="map"></div>
        </div>

    <!-- Leaflet JS для карты -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="config.js"></script>
    <script>
        const STATUS_TEXTS = {
            approved: 'Одобрено',
            declined: 'Отклонено',
            pending: 'Ожидает'
        };

        function escapeHtml(value) {
            if (value === null || value === undefined) {
                return '';
            }
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatDate(value) {
            if (!value) return '—';
            try {
                return new Date(value).toLocaleString('ru-RU');
            } catch (e) {
                return value;
            }
        }

        function renderPhotosSection(photos, reportId) {
            const list = Array.isArray(photos) ? photos : [];
            const count = list.length;

            const content = count === 0
                ? '<div class="no-photos">Фото пока не загружены</div>'
                : `<div class="photo-grid">${list.map(photo => {
                    const safeKey = escapeHtml(photo.s3_key || `photo-${photo.id || ''}`);
                    if (photo.url) {
                        const photoUrl = photo.url.startsWith('/')
                            ? `${API_URL}${photo.url}`
                            : photo.url;
                        const safeUrl = escapeHtml(photoUrl);
                        return `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer"><img src="${safeUrl}" alt="Фото заявки ${escapeHtml(reportId)}"></a>`;
                    }
                    return `<div class="photo-placeholder">${safeKey}</div>`;
                }).join('')}</div>`;

            return `<details class="photo-details">
                <summary>Фото (${count})</summary>
                ${content}
            </details>`;
        }

        function renderAppCard(app) {
            const reportId = app.id || app.report_id || 0;
            const numericId = Number(reportId) || 0;
            const location = escapeHtml(app.location || app.address || 'Адрес не указан');
            const comment = escapeHtml(app.comment || '-');
            const usernameBlock = app.telegram_username
                ? `@${escapeHtml(app.telegram_username)}`
                : '<i>не указан</i>';
            const statusKey = app.status || 'pending';
            const created = formatDate(app.created_at);

            return `<li class="app-card">
                <div class="app-header">
                    <div class="app-id">#${escapeHtml(reportId)}</div>
                    <span class="status-chip ${statusKey}">${STATUS_TEXTS[statusKey] || STATUS_TEXTS.pending}</span>
                </div>
                <div class="title-text">${location}</div>
                <div class="main-text">${comment}</div>
                <div class="app-meta">
                    <div><span class="label">Пользователь</span>${usernameBlock}</div>
                    <div><span class="label">Telegram ID</span>${app.telegram_user_id ? escapeHtml(app.telegram_user_id) : '—'}</div>
                    <div><span class="label">Создано</span>${escapeHtml(created)}</div>
                </div>
                ${renderPhotosSection(app.photos, reportId)}
                <div class="app-actions">
                    <button onclick="moderate(${numericId}, 'approved')">Одобрить</button>
                    <button onclick="moderate(${numericId}, 'declined')">Отклонить</button>
                </div>
            </li>`;
        }

        let admin_pw = '';
        document.getElementById('admin-login').onsubmit = async function(e) {
            e.preventDefault();
            admin_pw = document.getElementById('admin_pw').value;

            document.querySelector('.login-overlay').style.display = 'none';

            getApps();
        };

        // Глобальные переменные для карты
        let map = null;
        let markersLayer = null;
        let applicationsData = [];
        let currentView = 'list';

        // Переключение между списком и картой
        function switchView(view) {
            currentView = view;

            // Обновляем кнопки
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Переключаем вид
            document.querySelectorAll('.applications-view').forEach(v => v.classList.remove('active'));

            if (view === 'list') {
                document.getElementById('applications-list').classList.add('active');
            } else {
                document.getElementById('applications-map').classList.add('active');
                initMap();
            }
        }

        // Инициализация карты
        function initMap() {
            if (map) {
                map.invalidateSize();
                updateMapMarkers();
                return;
            }

            // Создаем карту с центром на Москве
            map = L.map('map').setView([55.751244, 37.618423], 11);

            // Добавляем слой OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);

            // Создаем слой для маркеров
            markersLayer = L.layerGroup().addTo(map);

            // Добавляем маркеры
            updateMapMarkers();
        }

        // Обновление маркеров на карте
        function updateMapMarkers() {
            if (!map || !markersLayer) return;

            // Очищаем старые маркеры
            markersLayer.clearLayers();

            const bounds = [];

            applicationsData.forEach(app => {
                // Используем координаты из FIAS данных
                const lat = app.latitude;
                const lon = app.longitude;

                if (!lat || !lon) {
                    console.warn('No coordinates for application:', app.id);
                    return;
                }

                // Создаем маркер
                const marker = L.marker([lat, lon]);

                // Создаем popup с информацией
                const popupContent = createPopupContent(app);
                marker.bindPopup(popupContent);

                // Добавляем маркер на карту
                marker.addTo(markersLayer);
                bounds.push([lat, lon]);
            });

            // Центрируем карту на всех маркерах
            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        // Создание контента для popup маркера
        function createPopupContent(app) {
            const status = STATUS_TEXTS[app.status] || 'Ожидает';
            const address = app.normalized_address || app.raw_address || 'Адрес не указан';
            const description = app.description || 'Нет описания';

            let photosHtml = '';
            if (app.photos && app.photos.length > 0) {
                const photoItems = app.photos.slice(0, 3).map(photo =>
                    `<img src="${API_URL}${photo.url}" alt="Фото" onclick="window.open('${API_URL}${photo.url}', '_blank')">`
                ).join('');
                photosHtml = `<div class="photos">${photoItems}</div>`;
            }

            return `
                <div class="popup-content">
                    <div class="title">Заявка #${app.report_id}</div>
                    <div class="address">${escapeHtml(address)}</div>
                    <div class="description">${escapeHtml(description)}</div>
                    <span class="status ${app.status || 'pending'}">${status}</span>
                    ${photosHtml}
                </div>
            `;
        }

        async function getApps() {
            let res = await fetch(`${API_URL}/api/applications`);
            let apps = await res.json();

            // Сохраняем данные глобально для карты
            applicationsData = apps;

            // Обновляем список
            const listHtml = apps.length
                ? apps.map(renderAppCard).join('')
                : '<li class="app-card"><div class="title-text">Заявки отсутствуют</div></li>';
            document.getElementById('app-list').innerHTML = listHtml;

            // Показываем переключатель если есть заявки с координатами
            const hasCoordinates = apps.some(app => app.latitude && app.longitude);
            if (hasCoordinates) {
                document.querySelector('.view-switcher').style.display = 'flex';
            }

            // Обновляем карту если она активна
            if (currentView === 'map' && map) {
                updateMapMarkers();
            }
        }

        async function moderate(idx, status) {
            await fetch(`${API_URL}/api/applications/moderate`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({idx, status, admin_password: admin_pw})
            });
            getApps();
        }
        </script>
    </body>
</html>
