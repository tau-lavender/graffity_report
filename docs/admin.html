<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>GraffityReport-Admin</title>

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:opsz@14..32&display=swap" rel="stylesheet">

        <link rel="stylesheet" href="admin.css">
    </head>
    <body>
        <div class="login-overlay">
            <div class="card-password">
                <form id="admin-login" class="form-password">
                    <input type="password" id="admin_pw" class="password-input" placeholder="Введите пароль" required>
                    <button type="submit" class="button-enter">Вход</button>
                </form>
            </div>
        </div>

        <div><ul id="app-list"></ul></div>

    <script src="config.js"></script>
    <script>
        function sha512(str) {
            return crypto.subtle.digest("SHA-512", new TextEncoder("utf-8").encode(str)).then(buf => {
                return Array.prototype.map.call(new Uint8Array(buf), x=>(('00'+x.toString(16)).slice(-2))).join('');
            });
        }
        const STATUS_TEXTS = {
            approved: 'Одобрено',
            declined: 'Отклонено',
            pending: 'Ожидает'
        };

        function escapeHtml(value) {
            if (value === null || value === undefined) {
                return '';
            }
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatDate(value) {
            if (!value) return '—';
            try {
                return new Date(value).toLocaleString('ru-RU');
            } catch (e) {
                return value;
            }
        }

        function renderPhotosSection(photos, reportId) {
            const list = Array.isArray(photos) ? photos : [];
            const count = list.length;

            const content = count === 0
                ? '<div class="no-photos">Фото пока не загружены</div>'
                : `<div class="photo-grid">${list.map(photo => {
                    const safeKey = escapeHtml(photo.s3_key || `photo-${photo.id || ''}`);
                    if (photo.url) {
                        const photoUrl = photo.url.startsWith('/')
                            ? `${API_URL}${photo.url}`
                            : photo.url;
                        const safeUrl = escapeHtml(photoUrl);
                        return `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer"><img src="${safeUrl}" alt="Фото заявки ${escapeHtml(reportId)}"></a>`;
                    }
                    return `<div class="photo-placeholder">${safeKey}</div>`;
                }).join('')}</div>`;

            return `<details class="photo-details">
                <summary>Фото (${count})</summary>
                ${content}
            </details>`;
        }

        function renderAppCard(app) {
            const reportId = app.id || app.report_id || 0;
            const numericId = Number(reportId) || 0;
            const location = escapeHtml(app.location || app.address || 'Адрес не указан');
            const comment = escapeHtml(app.comment || '-');
            const usernameBlock = app.telegram_username
                ? `@${escapeHtml(app.telegram_username)}`
                : '<i>не указан</i>';
            const statusKey = app.status || 'pending';
            const created = formatDate(app.created_at);

            return `<li class="app-card">
                <div class="app-header">
                    <div class="app-id">#${escapeHtml(reportId)}</div>
                    <span class="status-chip ${statusKey}">${STATUS_TEXTS[statusKey] || STATUS_TEXTS.pending}</span>
                </div>
                <div class="title-text">${location}</div>
                <div class="main-text">${comment}</div>
                <div class="app-meta">
                    <div><span class="label">Пользователь</span>${usernameBlock}</div>
                    <div><span class="label">Telegram ID</span>${app.telegram_user_id ? escapeHtml(app.telegram_user_id) : '—'}</div>
                    <div><span class="label">Создано</span>${escapeHtml(created)}</div>
                </div>
                ${renderPhotosSection(app.photos, reportId)}
                <div class="app-actions">
                    <button onclick="moderate(${numericId}, 'approved')">Одобрить</button>
                    <button onclick="moderate(${numericId}, 'declined')">Отклонить</button>
                </div>
            </li>`;
        }

        let admin_pw = '';
        document.getElementById('admin-login').onsubmit = async function(e) {
            e.preventDefault();
            const passwordInput = document.getElementById('admin_pw').value;
            admin_pw = await sha512(passwordInput);

            try {
                const response = await fetch(`${API_URL}/api/admin/verify`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({password_hash: admin_pw})
                });

                if (!response.ok) {
                    alert('Неверный пароль');
                    return;
                }

                document.querySelector('.login-overlay').style.display = 'none';
                getApps();
            } catch (error) {
                console.error('Error verifying password:', error);
                alert('Ошибка проверки пароля');
            }
        };

        async function getApps() {
            let res = await fetch(`${API_URL}/api/applications`);
            let apps = await res.json();
            const listHtml = apps.length
                ? apps.map(renderAppCard).join('')
                : '<li class="app-card"><div class="title-text">Заявки отсутствуют</div></li>';
            document.getElementById('app-list').innerHTML = listHtml;
        }        async function moderate(idx, status) {
            await fetch(`${API_URL}/api/applications/moderate`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({idx, status, admin_password: admin_pw})
            });
            getApps();
        }
        </script>
    </body>
</html>
